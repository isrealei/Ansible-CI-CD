- name: Setting up vprofile stack
  hosts: localhost
  connection: local
  gather_facts: no
  tasks: 
  - name: Importing my variables
    include_vars: vars/vpc_setups

  - name: Importing ami variables
    include_vars: vars/vpro-stack

  - name: Importing ami variables
    include_vars: vars/output_vars


  - name: creating a key pair for my instances
    ec2_key: 
      name: vpro-key
      state: present
      region: "{{region}}"
    register: vpro_key

  - name: Storing key into text file
    copy: 
     content: "{{vpro_key.key.private_key}}"
     dest:  "./vpro_key.pem"
     mode: 0600
    when: vpro_key.changed

  - name: create load balancer security group
    ec2_group:
      name: vproLB_sg
      description: Allow port 80 from anywhere
      vpc_id: "{{vpcid}}"
      region: "{{region}}"
      rules:
      - proto: tcp
        from_port: 80
        to_port: 80
        cidr_ip: 0.0.0.0/0
    register: vproLB_sg
   
  - name: create security group for my instances in private subnet
    ec2_group:
      name: vpro_sg
      description: Allow port 80 from anywhere
      vpc_id: "{{vpcid}}"
      region: "{{region}}"
      purge_rules: no
      rules:
      - proto: tcp
        from_port: 80
        to_port: 80
        group_id: "{{vproLB_sg.group_id}}"
      - proto: tcp
        from_port: 22
        to_port: 22
        group_id: "{{basHostid}}"
    register: vpro_sg



  - name: update security group with its own sg id
    ec2_group:
      name: vpro_sg
      description: Allow port 80 from anywhere
      vpc_id: "{{vpcid}}"
      region: "{{region}}"
      purge_rules: no
      rules:
      - proto: all
        group_id: "{{vpro_sg.group_id}}"
  
  
  - name: Creating nginx web01
    ec2:
      key_name: vpro-key
      instance_type: t2.micro
      region: "{{region}}"
      image: "{{nginx_ami}}"
      wait: yes
      wait_timeout: 300
      zone: "{{zone1}}"
      vpc_subnet_id: "{{pri1id}}"
      group_id: "{{ vpro_sg.group_id}}"
      exact_count: 1
      instance_tags:
        Name: "web01"
        Project: vprofile
        Owner: DevOps-team
      count_tag:
        Name: "web01"
        Project: vprofile
        Owner: DevOps-team
    register: web01_out

  - name: Creating tomcat app01
    ec2:
      key_name: vpro-key
      instance_type: t2.micro
      region: "{{region}}"
      image: "{{tomcat_ami}}"
      wait: yes
      wait_timeout: 300
      zone: "{{zone1}}"
      vpc_subnet_id: "{{pri1id}}"
      group_id: "{{ vpro_sg.group_id}}"
      exact_count: 1
      instance_tags:
        Name: "app01"
        Project: vprofile
        Owner: DevOps-team
      count_tag:
        Name: "app01"
        Project: vprofile
        Owner: DevOps-team
    register: app01_out

  - name: Creating memcached mc01
    ec2:
      key_name: vpro-key
      instance_type: t2.micro
      region: "{{region}}"
      image: "{{memcached_ami}}"
      wait: yes
      wait_timeout: 300
      zone: "{{zone1}}"
      vpc_subnet_id: "{{pri1id}}"
      group_id: "{{ vpro_sg.group_id}}"
      exact_count: 1
      instance_tags:
        Name: "mc01"
        Project: vprofile
        Owner: DevOps-team
      count_tag:
        Name: "mc01"
        Project: vprofile
        Owner: DevOps-team
    register: mc01_out


  - name: Creating rabbitmq rmq01
    ec2:
      key_name: vpro-key
      instance_type: t2.micro
      region: "{{region}}"
      image: "{{rabbitmq_ami}}"
      wait: yes
      wait_timeout: 300
      zone: "{{zone1}}"
      vpc_subnet_id: "{{pri1id}}"
      group_id: "{{ vpro_sg.group_id}}"
      exact_count: 1
      instance_tags:
        Name: "rmq01"
        Project: vprofile
        Owner: DevOps-team
      count_tag:
        Name: "rmq01"
        Project: vprofile
        Owner: DevOps-team
    register: rmq01_out

  - name: Creating mysql db01
    ec2:
      key_name: vpro-key
      instance_type: t2.micro
      region: "{{region}}"
      image: "{{mysql_ami}}"
      wait: yes
      wait_timeout: 300
      zone: "{{zone1}}"
      vpc_subnet_id: "{{pri1id}}"
      group_id: "{{ vpro_sg.group_id}}"
      exact_count: 1
      instance_tags:
        Name: "db01"
        Project: vprofile
        Owner: DevOps-team
      count_tag:
        Name: "db01"
        Project: vprofile
        Owner: DevOps-team
    register: db01_out

  - debug: 
     var: db01_out

 

